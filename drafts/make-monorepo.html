<!DOCTYPE html>
<!--[if lt IE 7]>      <html class='no-js lt-ie9 lt-ie8 lt-ie7'> <![endif]-->
<!--[if IE 7]>         <html class='no-js lt-ie9 lt-ie8'> <![endif]-->
<!--[if IE 8]>         <html class='no-js lt-ie9'> <![endif]-->
<!--[if gt IE 8]><!--> <html class='no-js' itemscope itemtype='http://schema.org/WebPage'> <!--<![endif]-->
<!-- Head -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Site Metadata -->
    <title>Make Monorepo | Mark Feltner's Website</title>
    <meta name="author" content="Mark Feltner">
    <meta name="description" content="If you would like to skip the ceremony and jump right into the code checkout the accompanying GitHub repo. This my account of using make to maintain and automate a “modern”-Javascript monorepo including why I did it, how, and maybe some reasons why you should or should not do …">


    <link rel="canonical" href="https://mark.feltner.me">
<link rel="stylesheet" type="text/css" href="https://mark.feltner.me/theme/css/vendor/normalize.css">
<link rel="stylesheet" type="text/css" href="https://mark.feltner.me/theme/css/vendor/typeset.css">
<link rel="stylesheet" type="text/css" href="https://mark.feltner.me/theme/css/grid.css">
<link rel="stylesheet" type="text/css" href="https://mark.feltner.me/theme/css/main.css">
<link rel="stylesheet" type="text/css" href="https://mark.feltner.me/theme/css/pygments.css">
<link media="print" rel="stylesheet" type="text/css" href="https://mark.feltner.me/theme/css/print.css"><!-- RSS Feeds -->
<!-- So Firefox can bookmark->"abo this site" -->
<link href="https://mark.feltner.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mark Feltner's Website Full Atom Feed" />
<link href="https://mark.feltner.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Mark Feltner's Website Full RSS Feed" />
<link href="https://mark.feltner.me/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Mark Feltner's Website Atom Feed" />
<link href="https://mark.feltner.me/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Mark Feltner's Website RSS Feed" />
<!-- Favicons -->
<link rel="shortcut icon" href="https://mark.feltner.me/theme/images/favicon.ico" type="image/x-icon">
<link rel="icon" href="https://mark.feltner.me/theme/images/favicon.ico" type="image/x-icon">
<!--
<link rel="shortcut icon" href="https://mark.feltner.me/images/apple-touch-icon.png">
<link rel="shortcut icon" href="https://mark.feltner.me/images/apple-touch-icon-72x72.png">
<link rel="shortcut icon" href="https://mark.feltner.me/images/apple-touch-icon-114x72.png">
-->
    <link rel="humans" type="text/plain" href="https://mark.feltner.me/humans.txt">
    <link rel="hackers" type="text/plain" href="https://mark.feltner.me/hackers.txt">
</head>
    <body>
        <!--[if lt IE 7]>
            <p class='browsehappy'>You are using an <strong>outdated</strong> browser. Please <a href='http://browsehappy.com/'>upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <div class='feltnerm-container'>
            <div class='feltnerm-header'>
<!-- Site Header -->
<div class="feltnerm-header-title">
    <header class="feltnerm-site-header" role="banner">
        <h1><a href="https://mark.feltner.me/">Mark Feltner's Website</a></h1>
    </header>
</div><div class='feltnerm-header-nav'>
    <div class='feltnerm-main-nav'>
        <nav aria-label="Main">
            <ul class="inline-list">
                <li><a href="/">home</a> · </li>
                <li><a href="/blog/">blog</a> · </li>
                <li><a href="/projects">projects</a> · </li>
                <li><a href="/portfolio">portfolio</a></li>
            </ul>
        </nav>
    </div>
</div>
            </div>

            <div class='feltnerm-content'>
<div class='feltnerm-article'>
    <article itemscope itemtype='http://schema.org/BlogPosting'>
        <header class='feltnerm-article-header'>
            <h1 itemprop='name'><a href='#' itemprop='url'>Make Monorepo</a></h1>
        </header>
        <div class='feltnerm-article-meta'>
            <span class='feltnerm-article-meta-date'>
                Written on <time itemprop='datePublished' datetime='2017-07-09T00:00:00-05:00' content='2017-07-09T00:00:00-05:00'>Sunday, July 09, 2017</time>
            </span>
        </div>
        <div class='feltnerm-article-content'>
            <main itemprop='articleBody' class='typeset'>
                <p><em>If you would like to skip the ceremony and jump right into the code checkout the
<a href="https://github.com/feltnerm/monorepo-es6-dev">accompanying GitHub repo</a>.</em></p>
<p>This my account of using <code>make</code> to maintain and automate a &ldquo;modern&rdquo;-Javascript monorepo including why I did it, how, and maybe some reasons why you should or should not do the same.</p>
<p>My first experience with <code>make</code> was years ago when I had to compile drivers for my WiFi card (atheros drivers and linux &hellip; ugh).
For a long time since then <code>make</code> was just the step you ran after
<code>./configure</code> and before <code>make install</code>. Until recently, I honestly thought
<code>make</code> was a build tool for specifically running gcc and compiling C programs.</p>
<p>A couple of months ago, when I was working on a <a href="http://danluu.com/monorepo/">monorepo</a> project. The current trendy tool to manage monorepos is called <a href="https://lernajs.io/">lerna</a>, and it is super dope. At the time of using it, lerna was still fairly immature and I was personally struggling to get everything working as I wanted.</p>
<p>After reading the blog post
<a href="https://mattandre.ws/2016/05/make-for-hipsters/">Make for Hipsters</a>, I had
become intrigued about the possiblities of good ol&rsquo; <code>make</code>. Had I dismissed
it all these years as an arcane tool?</p>
<p>Using <code>make</code> was intriguing because of its minimal nature. It had
zero-dependencies  and was generally already installed on most
developers&rsquo; machines. <code>make</code> also presented a very low barrier between the
task you were running and what was actually going on. No finding the GitHub
repo for some esoteric plugin, just being able to see exactly which shell
commands were run.</p>
<h1>Targets</h1>
<p>Along the way, I learned more about <code>make</code> than I ever could have imagined. For instance, I never realized the awesomeness and simplicity of <code>make</code>&lsquo;s rules and targets.</p>
<p>At a high level, the way <code>make</code> works is that you define how each expected
output file (i.e., target) should be created. Since <code>make</code> knows what the expected outcome of
a command should be, it will only run when it needs to.</p>
<div class="highlight"><pre><span></span><code><span class="nf">lib/index.js</span><span class="o">:</span> <span class="n">lib</span>/<span class="n">index</span>.<span class="n">jsx</span>
    babel --out-file lib/index.jsx lib/index.js
</code></pre></div>
<p>The example above is defining a rule to transpile a(n ES6+) JSX file into a ES5 Javascript file. <code>lib/index.js</code> is the target, <code>lib/index.jsx</code> is the component, and <code>babel ...</code> is the command used to produce the target from the component.</p>
<p>What this means is that babel will <em>only</em> run on <code>lib/index.jsx</code> <em>if and only if</em> that file has changed in some way. This is a huge win for large projects because re-compiling all the things anytime a file changes can get really expensive and annoying really fast.</p>
<h1>Dynamic Rules</h1>
<p>My mind was blown once I discovered how do create <code>make</code> rules dynamically.</p>
<p>Dynamic rules are one of the coolest parts of <code>make</code> I learned about, and
basically made it possible for <code>make</code> to manage <em>n</em> number of common packages within
a single repository. I had to ask a question on StackOverlow, and am so
gracious that I got two fantastic answers, including
<a href="http://stackoverflow.com/a/39604692/2405667">one</a> that really spelled it out
for me.</p>
<p>In a monorepo the structure might be something like this (in my case it <em>was</em> like this):</p>
<div class="highlight"><pre><span></span><code>- Makefile
- packages
  | foo
    | lib
    - src
  - bar
    | lib
    - src
</code></pre></div>
<p>As a lazy programmer (and person in general) I did <em>not</em> want to keep adding new Makefile rules and targets for each new package that I&rsquo;d be adding. This is where dynamic rules come in.</p>
<p>The following code snippet is the gist of it (I&rsquo;d have to write another (couple) blog posts to explain exactly what&rsquo;s going on here). For any questions I&rsquo;d suggest checking out my <a href="http://stackoverflow.com/a/39604692/2405667">StackOverflow question and subsequent answers</a>, or checking out the <a href="https://www.gnu.org/software/make/manual/make.html">GNU Make</a> documentation.</p>
<div class="highlight"><pre><span></span><code><span class="c"># Directories</span>
<span class="nv">PKGS_ROOT</span> <span class="o">:=</span> packages
<span class="nv">PKGS_SRCDIR</span> <span class="o">:=</span> src
<span class="nv">PKGS_OUTDIR</span> <span class="o">:=</span> lib

<span class="c"># Expands to the source directory for the specified package</span>
<span class="nv">pkg-srcdir</span> <span class="o">=</span> <span class="k">$(</span>PKGS_ROOT<span class="k">)</span>/<span class="nv">$1</span>/<span class="k">$(</span>PKGS_SRCDIR<span class="k">)</span>
<span class="c"># Expands to the output directory for the specified package</span>
<span class="nv">pkg-libdir</span> <span class="o">=</span> <span class="k">$(</span>PKGS_ROOT<span class="k">)</span>/<span class="nv">$1</span>/<span class="k">$(</span>PKGS_OUTDIR<span class="k">)</span>

<span class="c"># Expands to all output targets for the specified package</span>
<span class="nv">pkg-libs-js</span> <span class="o">=</span> <span class="k">$(</span>addprefix <span class="k">$(</span>call pkg-libdir,<span class="nv">$1</span><span class="k">)</span>/,<span class="k">$(</span>patsubst %.jsx,%.js,<span class="k">$(</span>notdir <span class="k">$(</span>wildcard <span class="k">$(</span>call pkg-srcdir,<span class="nv">$1</span><span class="k">)</span>/*.js*<span class="k">))))</span>

<span class="c"># Defines the following rules for the specified package:</span>
<span class="c">## PER-PACKAGE RULES START HERE</span>
<span class="cp">define pkg-rules</span>

<span class="c"># build rule for .js(x) files</span>
<span class="nf">$(call pkg-libdir,$1)/%.js</span><span class="o">:</span> <span class="k">$(</span><span class="nv">call</span> <span class="nv">pkg-srcdir</span>,<span class="k">$</span><span class="nv">1</span><span class="k">)</span>/%.<span class="n">js</span>* <span class="p">|</span> <span class="k">$(</span><span class="nv">call</span> <span class="nv">pkg-libdir</span>,<span class="k">$</span><span class="nv">1</span><span class="k">)</span>
        <span class="k">$(</span>TRANSPILER<span class="k">)</span> <span class="k">$(</span>TRANSPILER_OPTS<span class="k">)</span> --out-file <span class="nv">$$</span>@ <span class="nv">$$</span>^

<span class="cp">endef</span>
<span class="c">## PER-PACKAGE RULES END HERE</span>

<span class="c"># Creates rules for the specified package</span>
<span class="nv">add-pkg</span> <span class="o">=</span> <span class="k">$(</span><span class="nb">eval</span> <span class="k">$(</span>call pkg-rules,<span class="nv">$1</span><span class="k">))</span>

<span class="c"># Create rules for all packages</span>
<span class="nv">PKGS</span> <span class="o">:=</span> <span class="k">$(</span>notdir <span class="k">$(</span>wildcard <span class="k">$(</span>PKGS_ROOT<span class="k">)</span>/*<span class="k">))</span>
<span class="k">$(</span><span class="nv">foreach</span> <span class="nv">p</span>,<span class="k">$(</span><span class="nv">PKGS</span><span class="k">)</span>,<span class="k">$(</span><span class="nv">call</span> <span class="nv">add-pkg</span>,<span class="k">$</span><span class="nv">p</span><span class="k">))</span><span class="w"></span>
</code></pre></div>
<p>We start off with a directory of packages: <code>PKGS_ROOT</code>. Then, we define <code>PKGS</code> to be all the sub-directories of <code>PKGS_ROOT</code> (<code>PKGS := $(notdir $(wildcard $(PKGS_ROOT)/*))</code>). Last, we execute a command <code>add-pkg</code> for each directory found in <code>PKGS</code>:</p>
<div class="highlight"><pre><span></span><code>add-pkg = $(eval $(call pkg-rules,$1))
PKGS := $(notdir $(wildcard $(PKGS_ROOT)/*))
$(foreach p,$(PKGS),$(call add-pkg,$p))
</code></pre></div>
<p>As you can see, unfortunately, <code>make</code> has some pretty esoteric syntax that isn&rsquo;t exactly inuitive on your first try. Most of the documentation is really good (despite almost all of the examples dealing with C and C++ code), and there&rsquo;s a ton of examples and other resources online.</p>
<p>Also, <code>make</code> doesn&rsquo;t really have a community or plugin-ecosystem, as far as I know, so you won&rsquo;t find simple plug-n-go solutions (although you can <a href="https://github.com/tj/react-fatigue-dev">include other Makefiles</a>). One cool idea is to take the monorepo Makefile and take out the
monorepo-management commands to make generic and shareable build automation that will work in a variety of environments. It would be great if there was more of a modular <code>Makefile</code> community that&rsquo;d share generic snippets.</p>
<p>As a polyglot programmer, I&rsquo;ve used a variety of build tools. From grunt to gulp, pip to setup.py, maven to gradle, and more. Honestly, I love <code>make</code>. It is close to the &ldquo;metal&rdquo; in that I can see and edit the exact commands being run.</p>
<p>For now, I&rsquo;m going to stick with using <code>make</code> as the main source of automation for front-end development. Especially when a project has outgrown <a href="https://docs.npmjs.com/misc/scripts"><code>npm-scripts</code></a>. It is efficient, explicit, and I think it will be easy to grow my <code>Makefiles</code> as development tools come and go.</p>
<p>Actually, at my dayjob we are using <code>make</code> for frontend projects now. In fact, we have a monorepo &ndash; fully managed by <code>make</code> &ndash; of frontend packages that we can use to build common user interfaces. So far, <code>make</code> has been relatively successful. There&rsquo;s some unfamiliarity, but it works, and there is definitely opportunity to simplify the Makefile even more to allow for better interpretation.</p>
<p><code>Make</code> needs another shot. I&rsquo;d suggest giving it one.</p>
            </section>
        </div>
    </article>
</div>
            </div>

            <hr></hr>

            <div class='feltnerm-footer'>
<!-- Site Footer -->
<div class='feltnerm-site-footer'>
    <footer>
        <div class="feltnerm-footer-social">
            <ul class="inline-list">
                <li><a href="https://github.com/feltnerm">github</a> · </li>
                <li><a href="https://twitter.com/feltnermj">twitter</a> · </li>
                <li><a href="http://www.last.fm/user/plugitin">last.fm</a> · </li>
                <li><a href="mailto:mark+blog@feltner.me">email</a></li>
            </ul>
        </div>
        <div class="feltnerm-footer-meta">
            <ul class="inline-list">
                <li><a href="/feeds/all.rss.xml">rss</a> · </li>
                <li><a href="/feeds/all.atom.xml">atom</a> · </li>
                <li><a href="/style-guide">style</a> · </li>
                <li><a href="/credits">credits</a></li>
            </ul>
        </div>
        <div class="feltnerm-footer-copyright">
            <p>© 2022, Mark Feltner
            <p>This <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" rel="dct:type">work</span> is licensed under a
                <br><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
        </div>
    </footer>
</div>            </div>

<!-- Site Javascripts --><!-- Analytics -->
<script>
    var _gaq=[['_setAccount',''],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src='//www.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
        </div>

    </body>
</html>